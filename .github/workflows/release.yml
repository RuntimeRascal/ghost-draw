name: Release

on:
    push:
        tags:
            - 'v*.*.*' # Triggers on version tags like v1.0.0, v1.2.3, etc.

permissions:
    contents: write # Required for creating releases
    actions: read # Required for downloading artifacts

jobs:
    release:
        runs-on: windows-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Extract version from tag
              id: get_version
              shell: pwsh
              run: |
                  $tag = "${{ github.ref_name }}"
                  $version = $tag -replace '^v', ''
                  echo "VERSION=$version" >> $env:GITHUB_OUTPUT
                  echo "VERSION=$version" >> $env:GITHUB_ENV
                  Write-Host "Release version: $version"

            - name: Verify package.json version matches tag
              shell: pwsh
              run: |
                  $packageJson = Get-Content -Path "package.json" -Raw | ConvertFrom-Json
                  $packageVersion = $packageJson.version
                  $tagVersion = "${{ steps.get_version.outputs.VERSION }}"

                  if ($packageVersion -ne $tagVersion) {
                    Write-Error "Version mismatch! package.json has '$packageVersion' but tag is 'v$tagVersion'"
                    Write-Host "Make sure to update package.json and run Update-Version.ps1 before creating a release tag."
                    exit 1
                  }
                  Write-Host "‚úì Version verified: $packageVersion" -ForegroundColor Green

            - name: Download installer artifact
              uses: dawidd6/action-download-artifact@v6
              with:
                  workflow: ci.yml
                  branch: main
                  name: GhostDrawSetup-${{ env.VERSION }}
                  path: ./artifacts/installer

            - name: Download portable artifact
              uses: dawidd6/action-download-artifact@v6
              with:
                  workflow: ci.yml
                  branch: main
                  name: GhostDraw-${{ env.VERSION }}-portable
                  path: ./artifacts/portable

            - name: Verify downloaded artifacts
              shell: pwsh
              run: |
                  $msiPath = "./artifacts/installer/GhostDrawSetup-${{ env.VERSION }}.msi"
                  $zipPath = "./artifacts/portable/GhostDraw-${{ env.VERSION }}-portable.zip"

                  Write-Host "Checking artifacts..." -ForegroundColor Yellow

                  if (Test-Path $msiPath) {
                    $size = (Get-Item $msiPath).Length / 1MB
                    Write-Host "‚úì Installer: GhostDrawSetup-${{ env.VERSION }}.msi ($([math]::Round($size, 2)) MB)" -ForegroundColor Green
                  } else {
                    Write-Error "Installer not found at: $msiPath"
                    Write-Host "Make sure CI has run successfully for version ${{ env.VERSION }}"
                    exit 1
                  }

                  if (Test-Path $zipPath) {
                    $size = (Get-Item $zipPath).Length / 1MB
                    Write-Host "‚úì Portable: GhostDraw-${{ env.VERSION }}-portable.zip ($([math]::Round($size, 2)) MB)" -ForegroundColor Green
                  } else {
                    Write-Error "Portable ZIP not found at: $zipPath"
                    Write-Host "Make sure CI has run successfully for version ${{ env.VERSION }}"
                    exit 1
                  }

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ github.ref_name }}
                  name: GhostDraw v${{ env.VERSION }}
                  draft: false
                  prerelease: false
                  generate_release_notes: true
                  files: |
                      ./artifacts/installer/GhostDrawSetup-${{ env.VERSION }}.msi
                      ./artifacts/portable/GhostDraw-${{ env.VERSION }}-portable.zip
                  body: |
                      ## GhostDraw v${{ env.VERSION }}

                      ### Downloads

                      | File | Description |
                      |------|-------------|
                      | `GhostDrawSetup-${{ env.VERSION }}.msi` | Windows Installer (recommended) |
                      | `GhostDraw-${{ env.VERSION }}-portable.zip` | Portable version (no installation required) |

                      ### Requirements

                      - Windows 10/11 (64-bit)
                      - No additional dependencies needed (self-contained)

                      ### Quick Start

                      1. Download and run the installer, or extract the portable ZIP
                      2. Launch GhostDraw from Start Menu or the extracted folder
                      3. Press **Ctrl+Alt+D** and drag to draw on screen
                      4. Release the hotkey to clear the drawing

                      ---

                      üìù See below for auto-generated release notes with commit details.

            - name: Release summary
              shell: pwsh
              run: |
                  Write-Host ""
                  Write-Host "=====================================" -ForegroundColor Cyan
                  Write-Host " Release Complete! " -ForegroundColor Green
                  Write-Host "=====================================" -ForegroundColor Cyan
                  Write-Host ""
                  Write-Host "Version: v${{ env.VERSION }}" -ForegroundColor White
                  Write-Host "Assets:" -ForegroundColor White
                  Write-Host "  - GhostDrawSetup-${{ env.VERSION }}.msi" -ForegroundColor Gray
                  Write-Host "  - GhostDraw-${{ env.VERSION }}-portable.zip" -ForegroundColor Gray
                  Write-Host ""
                  Write-Host "View release: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" -ForegroundColor Cyan
