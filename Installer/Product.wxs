<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
  xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <?define ProductName="GhostDraw"?>
  <?define Manufacturer="RuntimeRascal"?>
  <?define UpgradeCode="A8B9C0D1-2E3F-4A5B-6C7D-8E9F0A1B2C3D"?>

  <Package Name="$(var.ProductName)"
    Manufacturer="$(var.Manufacturer)"
    Version="$(var.ProductVersion)"
    UpgradeCode="$(var.UpgradeCode)"
    Compressed="yes"
    InstallerVersion="500"
    Scope="perMachine">

    <MajorUpgrade
      DowngradeErrorMessage="A newer version of [ProductName] is already installed. Please uninstall the current version before installing this version."
      AllowSameVersionUpgrades="yes"
      Schedule="afterInstallInitialize" />

    <MediaTemplate EmbedCab="yes" />

    <!-- Enable internal UI -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <!-- Icon for Add/Remove Programs -->
    <Icon Id="AppIcon" SourceFile="..\Src\GhostDraw\Assets\favicon.ico" />
    <Property Id="ARPPRODUCTICON" Value="AppIcon" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/RuntimeRascal/ghost-draw" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />
    <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />

    <!-- Install location -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="$(var.ProductName)" />
    </StandardDirectory>

    <!-- Start Menu folder -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="$(var.ProductName)" />
    </StandardDirectory>

    <!-- Desktop folder -->
    <StandardDirectory Id="DesktopFolder" />

    <!-- Startup folder -->
    <StandardDirectory Id="StartupFolder" />

    <!-- Local AppData for settings -->
    <StandardDirectory Id="LocalAppDataFolder">
      <Directory Id="GhostDrawSettingsFolder" Name="$(var.ProductName)" />
    </StandardDirectory>

    <!-- Main Application Feature (Required) -->
    <Feature Id="MainApplication"
      Title="GhostDraw Application"
      Level="1"
      ConfigurableDirectory="INSTALLFOLDER"
      AllowAdvertise="no"
      Description="Core application files (required)">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="SettingsComponents" />
    </Feature>

    <!-- Start Menu Shortcut Feature (Default: Yes) -->
    <Feature Id="StartMenuShortcut"
      Title="Start Menu Shortcut"
      Level="1"
      AllowAdvertise="no"
      Description="Add a shortcut to the Start Menu">
      <ComponentRef Id="StartMenuShortcutComponent" />
    </Feature>

    <!-- Desktop Shortcut Feature (Default: No) -->
    <Feature Id="DesktopShortcut"
      Title="Desktop Shortcut"
      Level="1000"
      AllowAdvertise="no"
      Description="Add a shortcut to the Desktop">
      <ComponentRef Id="DesktopShortcutComponent" />
    </Feature>

    <!-- Startup Shortcut Feature (Default: No) -->
    <Feature Id="StartupShortcut"
      Title="Run at Windows Startup"
      Level="1000"
      AllowAdvertise="no"
      Description="Automatically start GhostDraw when you log in to Windows">
      <ComponentRef Id="StartupShortcutComponent" />
    </Feature>

    <!-- UI Customization -->
    <WixVariable Id="WixUILicenseRtf" Value="Resources\License.rtf" />
  </Package>

  <!-- UI Dialog Set - WiX v4 Syntax -->
  <Fragment>
    <UI Id="UserInterface">
      <ui:WixUI Id="WixUI_FeatureTree" />
      <UIRef Id="WixUI_ErrorProgressText" />
    </UI>
  </Fragment>

  <!-- Component Group auto-generated by Generate-FileList.ps1 script -->
  <?include HarvestedFiles.wxs?>

  <!-- Settings folder reference (persists across upgrades and uninstall) -->
  <Fragment>
    <ComponentGroup Id="SettingsComponents" Directory="GhostDrawSettingsFolder">
      <Component Id="SettingsFolderRef" Guid="A6B7C8D9-0E1F-2A3B-4C5D-6E7F8A9B0C1D">
        <CreateFolder />
        <!-- RemoveFolder only removes empty folders, so user files are preserved -->
        <RemoveFolder Id="RemoveSettingsFolder" On="uninstall" />
        <RegistryValue Root="HKCU"
          Key="Software\$(var.Manufacturer)\$(var.ProductName)"
          Name="SettingsPath"
          Value="[LocalAppDataFolder]$(var.ProductName)"
          Type="string"
          KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Shortcut Components -->
  <Fragment>
    <!-- Start Menu Shortcut -->
    <Component Id="StartMenuShortcutComponent"
      Guid="A1B2C3D4-5E6F-7A8B-9C0D-1E2F3A4B5C6D"
      Directory="ApplicationProgramsFolder">
      <Shortcut Id="StartMenuShortcut"
        Name="GhostDraw"
        Description="Draw directly on your screen"
        Target="[INSTALLFOLDER]GhostDraw.exe"
        WorkingDirectory="INSTALLFOLDER"
        Icon="AppIcon" />
      <RemoveFolder Id="CleanupStartMenu" On="uninstall" />
      <RegistryValue Root="HKCU"
        Key="Software\RuntimeRascal\GhostDraw\Shortcuts"
        Name="StartMenu"
        Value="1"
        Type="integer"
        KeyPath="yes" />
    </Component>

    <!-- Desktop Shortcut -->
    <Component Id="DesktopShortcutComponent"
      Guid="B2C3D4E5-6F7A-8B9C-0D1E-2F3A4B5C6D7E"
      Directory="DesktopFolder">
      <Shortcut Id="DesktopShortcut"
        Name="GhostDraw"
        Description="Draw directly on your screen"
        Target="[INSTALLFOLDER]GhostDraw.exe"
        WorkingDirectory="INSTALLFOLDER"
        Icon="AppIcon" />
      <RegistryValue Root="HKCU"
        Key="Software\RuntimeRascal\GhostDraw\Shortcuts"
        Name="Desktop"
        Value="1"
        Type="integer"
        KeyPath="yes" />
    </Component>

    <!-- Startup Shortcut -->
    <Component Id="StartupShortcutComponent"
      Guid="C3D4E5F6-7A8B-9C0D-1E2F-3A4B5C6D7E8F"
      Directory="StartupFolder">
      <Shortcut Id="StartupShortcut"
        Name="GhostDraw"
        Description="Draw directly on your screen"
        Target="[INSTALLFOLDER]GhostDraw.exe"
        Arguments="--minimized"
        WorkingDirectory="INSTALLFOLDER" />
      <RegistryValue Root="HKCU"
        Key="Software\RuntimeRascal\GhostDraw\Shortcuts"
        Name="Startup"
        Value="1"
        Type="integer"
        KeyPath="yes" />
    </Component>
  </Fragment>
</Wix>